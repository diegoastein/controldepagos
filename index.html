<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pagos - Diagn√≥stico</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background: #f3f4f6; font-family: sans-serif; }
        #debug-screen { position: fixed; inset: 0; background: #1e1b4b; color: white; z-index: 9999; padding: 20px; overflow: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .log-line { margin-bottom: 5px; font-family: monospace; font-size: 14px; width: 100%; max-width: 600px; text-align: left; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; font-weight: bold; background: rgba(255,0,0,0.1); padding: 5px; border-radius: 4px; border: 1px solid #f87171; margin-top: 10px; }
        .log-info { color: #93c5fd; }
        button { background: white; color: black; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="debug-screen">
        <h1 class="text-2xl font-bold mb-4">üîç Diagn√≥stico de Conexi√≥n</h1>
        <div id="logs"></div>
        <button onclick="intentarConexion()" id="btnRetry">Reintentar Conexi√≥n</button>
        <button onclick="window.location.reload()" class="mt-2 bg-gray-500 text-white">Recargar P√°gina</button>
    </div>

    <div id="app-content" class="hidden">
        <h1 class="text-center mt-10 text-2xl text-green-600 font-bold">¬°CONEXI√ìN EXITOSA! üéâ</h1>
        <p class="text-center text-gray-600">Ahora puedes volver a cargar tu c√≥digo original.</p>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN (TUS CLAVES REALES) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBk-LaNtS15CYhycTl7w6w9xmrVxM88L-M",
            authDomain: "pagos-6f294.firebaseapp.com",
            projectId: "pagos-6f294",
            storageBucket: "pagos-6f294.firebasestorage.app",
            messagingSenderId: "835956011658",
            appId: "1:835956011658:web:cf1cb8331e22b5bab37373"
        };

        const logsDiv = document.getElementById('logs');

        function log(msg, type = 'info') {
            console.log(msg);
            const div = document.createElement('div');
            div.className = `log-line log-${type}`;
            div.innerText = `> ${msg}`;
            logsDiv.appendChild(div);
        }

        function intentarConexion() {
            logsDiv.innerHTML = '';
            log("Iniciando pruebas...", "info");

            // Paso 1: Inicializar
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    log("‚úÖ Firebase inicializado.", "success");
                } else {
                    log("‚ÑπÔ∏è Firebase ya estaba activo.", "info");
                }
            } catch (e) {
                log("‚ùå ERROR FATAL AL INICIAR: " + e.message, "error");
                return;
            }

            const auth = firebase.auth();
            const db = firebase.firestore();

            // Paso 2: Autenticaci√≥n
            log("Intentando autenticaci√≥n an√≥nima...", "info");
            
            auth.signInAnonymously()
                .then((userCredential) => {
                    log("‚úÖ Login exitoso. ID: " + userCredential.user.uid, "success");
                    pruebaBaseDeDatos(db, userCredential.user.uid);
                })
                .catch((error) => {
                    let explicacion = "";
                    if (error.code === 'auth/unauthorized-domain') {
                        explicacion = "\n‚ö†Ô∏è EL DOMINIO NO EST√Å AUTORIZADO.\nTienes que ir a Firebase Console -> Authentication -> Settings -> Authorized Domains y agregar: " + window.location.hostname;
                    } else if (error.code === 'auth/operation-not-allowed') {
                        explicacion = "\n‚ö†Ô∏è EL MODO AN√ìNIMO EST√Å DESACTIVADO.\nVe a Firebase Console -> Authentication -> Sign-in method y activa 'An√≥nimo'.";
                    } else if (error.code === 'auth/api-key-not-valid') {
                        explicacion = "\n‚ö†Ô∏è API KEY INV√ÅLIDA.\nVerifica que copiaste bien la 'apiKey' en el c√≥digo.";
                    }

                    log("‚ùå ERROR DE LOGIN: " + error.code + " - " + error.message + explicacion, "error");
                });
        }

        function pruebaBaseDeDatos(db, uid) {
            log("Probando lectura/escritura en base de datos...", "info");
            const testRef = db.collection("users").doc(uid).collection("test").doc("ping");

            testRef.set({ fecha: new Date().toISOString(), mensaje: "Hola Firebase" })
                .then(() => {
                    log("‚úÖ Escritura exitosa en DB.", "success");
                    log("üöÄ TODO FUNCIONA PERFECTO.", "success");
                    log("Ya puedes volver a poner tu c√≥digo original.", "success");
                    document.getElementById('debug-screen').style.background = "#064e3b"; // Verde oscuro
                })
                .catch((error) => {
                    let explicacion = "";
                    if (error.code === 'permission-denied') {
                        explicacion = "\n‚ö†Ô∏è PERMISO DENEGADO.\nVe a Firebase Console -> Firestore Database -> Reglas y c√°mbialas a 'allow read, write: if true;'";
                    }
                    log("‚ùå ERROR DE BASE DE DATOS: " + error.code + " - " + error.message + explicacion, "error");
                });
        }

        // Arrancar al cargar
        window.onload = intentarConexion;
    </script>
</body>
</html>
