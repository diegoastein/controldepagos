<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pagos Familiar</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Dependencias UI -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CORRECCIÓN: Usamos unpkg versión específica UMD -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    
    <!-- Gráficos -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const SUPABASE_URL = 'https://sgqmpshjycbprifpxztl.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncW1wc2hqeWNicHJpZnB4enRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTYwNjQsImV4cCI6MjA4MTQ5MjA2NH0.mhae-9WuVGlXZwKlqUvplWGtlwbiEubSWo5MELnyWQk';
        
        const { useState, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = window.Recharts || {};

        // ==========================================
        // COMPONENTES DE ICONOS
        // ==========================================
        const IconDashboard = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>;
        const IconServices = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>;
        const IconStats = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>;
        const IconCheck = () => <svg className="w-8 h-8 text-success" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>;
        const IconCircle = () => <svg className="w-8 h-8 text-gray-300 hover:text-primary transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth="2" /></svg>;
        const IconTrash = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;

        // ==========================================
        // VISTA: PANTALLA DE ERROR/CONFIG
        // ==========================================
        const ConfigRequired = ({ error }) => (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50">
                <div className="card p-8 w-full max-w-lg border-l-8 border-yellow-400">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">⚠️ Cargando Aplicación</h1>
                    {error ? (
                         <div className="mb-4">
                            <p className="text-red-600 font-bold">Problema de conexión:</p>
                            <p className="text-gray-600 text-sm">{error}</p>
                            <p className="mt-2 text-xs text-gray-500">
                                Estamos intentando conectar con los servidores de Supabase...
                            </p>
                         </div>
                    ) : (
                        <p className="text-gray-600 animate-pulse">Iniciando sistema...</p>
                    )}
                </div>
            </div>
        );

        // ==========================================
        // VISTA: LOGIN
        // ==========================================
        const AuthView = ({ supabaseInstance }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const { data, error } = await supabaseInstance.auth.signInWithPassword({ email, password });
                if (error) {
                    const { error: upError } = await supabaseInstance.auth.signUp({ email, password });
                    if (upError) setMsg('Error: ' + error.message);
                    else setMsg('Cuenta creada! Revisa tu email o inicia sesión.');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <h1 className="text-2xl font-bold text-center text-primary mb-6">Mis Pagos</h1>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full p-3 border rounded-lg" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input type="password" placeholder="Contraseña" className="w-full p-3 border rounded-lg" value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button disabled={loading} className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">
                                {loading ? 'Cargando...' : 'Entrar / Registrarse'}
                            </button>
                            {msg && <p className="text-center text-sm text-gray-500 mt-2">{msg}</p>}
                        </form>
                    </div>
                </div>
            );
        };

        // ==========================================
        // VISTA: SERVICIOS
        // ==========================================
        const ServicesView = ({ userId, supabaseInstance }) => {
            const [services, setServices] = useState([]);
            const [form, setForm] = useState({ name: '', day: 10, isCC: false });

            useEffect(() => { loadServices() }, []);

            const loadServices = async () => {
                const { data } = await supabaseInstance.from('services').select('*').order('created_at');
                setServices(data || []);
            };

            const addService = async (e) => {
                e.preventDefault();
                await supabaseInstance.from('services').insert([{ 
                    user_id: userId, name: form.name, default_due_day: form.day, is_credit_card: form.isCC 
                }]);
                setForm({ name: '', day: 10, isCC: false });
                loadServices();
            };

            const deleteService = async (id) => {
                if(confirm("¿Borrar este servicio?")) {
                    await supabaseInstance.from('services').delete().eq('id', id);
                    loadServices();
                }
            };

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-2xl mx-auto fade-in">
                    <h2 className="text-xl font-bold mb-4">Configurar Servicios</h2>
                    
                    <form onSubmit={addService} className="card p-4 mb-6 grid gap-4">
                        <input type="text" placeholder="Nombre (ej: Netflix)" className="w-full p-2 border rounded" 
                            value={form.name} onChange={e => setForm({...form, name: e.target.value})} required />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="text-xs text-gray-500">Día vencimiento</label>
                                <input type="number" min="1" max="31" className="w-full p-2 border rounded" 
                                    value={form.day} onChange={e => setForm({...form, day: e.target.value})} />
                            </div>
                            <div className="flex items-center gap-2 pt-4">
                                <input type="checkbox" checked={form.isCC} onChange={e => setForm({...form, isCC: e.target.checked})} className="w-5 h-5 rounded text-primary focus:ring-primary" />
                                <label className="text-sm">Es Tarjeta</label>
                            </div>
                        </div>
                        <button className="bg-primary text-white py-2 rounded font-medium hover:bg-blue-600 transition">Agregar</button>
                    </form>

                    <div className="space-y-3">
                        {services.map(s => (
                            <div key={s.id} className="card p-4 flex justify-between items-center border-l-4 border-primary hover:shadow-md transition">
                                <div>
                                    <h3 className="font-bold">{s.name}</h3>
                                    <p className="text-xs text-gray-500">Vence día {s.default_due_day} {s.is_credit_card ? '(Tarjeta)' : ''}</p>
                                </div>
                                <button onClick={() => deleteService(s.id)} className="text-gray-400 hover:text-danger"><IconTrash /></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // VISTA: DASHBOARD
        // ==========================================
        const DashboardView = ({ userId, supabaseInstance }) => {
            const [date, setDate] = useState(new Date());
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => { loadData() }, [date]);

            const loadData = async () => {
                setLoading(true);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                const { data: services } = await supabaseInstance.from('services').select('*').eq('active', true);
                const { data: payments } = await supabaseInstance.from('payments').select('*').eq('month', month).eq('year', year);

                if (services) {
                    const merged = services.map(svc => {
                        const pay = payments?.find(p => p.service_id === svc.id);
                        return {
                            ...svc,
                            payment_id: pay?.id,
                            amount_due: pay?.amount_due || 0,
                            amount_paid: pay?.amount_paid || 0,
                            is_paid: pay?.is_paid || false,
                            skipped: pay?.skipped || false,
                        };
                    });
                    setItems(merged);
                }
                setLoading(false);
            };

            const totalDue = items.filter(i => !i.skipped).reduce((acc, c) => acc + Number(c.amount_due), 0);
            const totalPaid = items.filter(i => !i.skipped).reduce((acc, c) => acc + Number(c.amount_paid), 0);
            const remaining = totalDue - totalPaid;

            const updatePayment = async (item, updates) => {
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                
                const payload = {
                    service_id: item.id, user_id: userId, month, year, ...updates
                };
                if (item.payment_id) payload.id = item.payment_id;

                await supabaseInstance.from('payments').upsert(payload);
                loadData();
            };

            const handlePay = async (item) => {
                if (item.is_paid) {
                    await updatePayment(item, { is_paid: false });
                    return;
                }

                const val = prompt(`Pagar ${item.name}. Monto:`, item.amount_due);
                if (val === null) return;
                const paid = parseFloat(val);
                if (isNaN(paid)) return;

                if (item.is_credit_card && paid < item.amount_due) {
                    const diff = item.amount_due - paid;
                    if(confirm(`Pago parcial detectado. ¿Mover saldo restante ($${diff}) al mes siguiente?`)) {
                        let nextM = date.getMonth() + 2;
                        let nextY = date.getFullYear();
                        if (nextM > 12) { nextM = 1; nextY++; }

                        const { data: existing } = await supabaseInstance.from('payments')
                            .select('*').eq('service_id', item.id).eq('month', nextM).eq('year', nextY).single();
                        
                        const newDue = (existing?.amount_due || 0) + diff;
                        
                        await supabaseInstance.from('payments').upsert({
                            id: existing?.id, service_id: item.id, user_id: userId, 
                            month: nextM, year: nextY, amount_due: newDue
                        });
                        alert(`Se sumaron $${diff} a ${item.name} en el próximo mes.`);
                    }
                }
                await updatePayment(item, { is_paid: true, amount_paid: paid });
            };

            const changeMonth = (delta) => {
                const d = new Date(date);
                d.setMonth(d.getMonth() + delta);
                setDate(d);
            };

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-4xl mx-auto fade-in">
                    <div className="flex justify-between items-center mb-6 card p-3">
                        <button onClick={() => changeMonth(-1)} className="p-2 font-bold text-xl hover:bg-gray-100 rounded">&lt;</button>
                        <h2 className="text-xl font-bold capitalize">{date.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 font-bold text-xl hover:bg-gray-100 rounded">&gt;</button>
                    </div>

                    <div className="grid grid-cols-3 gap-2 mb-6 text-center">
                        <div className="bg-blue-100 p-2 rounded text-blue-800">
                            <div className="text-xs uppercase font-bold">Total</div>
                            <div className="font-bold text-lg">${totalDue}</div>
                        </div>
                        <div className="bg-green-100 p-2 rounded text-green-800">
                            <div className="text-xs uppercase font-bold">Pagado</div>
                            <div className="font-bold text-lg">${totalPaid}</div>
                        </div>
                        <div className="bg-red-100 p-2 rounded text-red-800 border border-red-200">
                            <div className="text-xs uppercase font-bold">Resta</div>
                            <div className="font-bold text-lg">${remaining}</div>
                        </div>
                    </div>

                    <div className="space-y-3">
                        {loading ? <div className="text-center p-4 text-gray-500">Cargando...</div> : items.map(item => (
                            <div key={item.id} className={`card p-4 border-l-4 transition-all ${item.is_paid ? 'border-success opacity-70' : item.skipped ? 'border-gray-300 opacity-50 grayscale' : 'border-primary'}`}>
                                <div className="flex justify-between mb-2">
                                    <div>
                                        <h3 className={`font-bold ${item.skipped ? 'line-through':''}`}>{item.name}</h3>
                                        <p className="text-xs text-gray-500">Vence: {item.default_due_day}</p>
                                    </div>
                                    <button onClick={() => updatePayment(item, { skipped: !item.skipped })} className="text-xs bg-gray-100 px-2 py-1 rounded h-fit hover:bg-gray-200">
                                        {item.skipped ? 'Activar' : 'Saltar'}
                                    </button>
                                </div>
                                
                                {!item.skipped && (
                                    <div className="flex items-end gap-3">
                                        <div className="flex-1">
                                            <label className="text-[10px] uppercase font-bold text-gray-400">Importe</label>
                                            <input type="number" className="w-full text-lg font-bold border-b border-gray-200 outline-none bg-transparent focus:border-primary"
                                                placeholder="0" value={item.amount_due || ''}
                                                onChange={e => updatePayment(item, { amount_due: e.target.value })}
                                            />
                                        </div>
                                        <button onClick={() => handlePay(item)} className="transition-transform active:scale-95">
                                            {item.is_paid ? <IconCheck /> : <IconCircle />}
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // VISTA: ESTADÍSTICAS
        // ==========================================
        const StatsView = ({ supabaseInstance }) => {
            const [data, setData] = useState([]);

            useEffect(() => {
                const calc = async () => {
                    const year = new Date().getFullYear();
                    const { data: payments } = await supabaseInstance.from('payments').select('month, amount_paid').eq('year', year).eq('is_paid', true);
                    
                    const chartData = Array.from({length: 12}, (_, i) => {
                        const m = i + 1;
                        const total = payments?.filter(p => p.month === m).reduce((acc, c) => acc + c.amount_paid, 0) || 0;
                        return { name: new Date(2024, i, 1).toLocaleString('es-ES', {month:'short'}), total };
                    });
                    setData(chartData);
                };
                calc();
            }, []);

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-4xl mx-auto h-screen flex flex-col fade-in">
                    <h2 className="text-xl font-bold mb-4">Gastos Anuales</h2>
                    <div className="card p-4 flex-1 max-h-[500px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={data}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                <YAxis axisLine={false} tickLine={false} />
                                <Tooltip />
                                <Bar dataKey="total" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        // ==========================================
        // APP PRINCIPAL
        // ==========================================
        const App = () => {
            const [supabaseInstance, setSupabaseInstance] = useState(null);
            const [session, setSession] = useState(null);
            const [view, setView] = useState('dashboard');
            const [initError, setInitError] = useState(null);

            // Efecto de Inicialización con Polling (Reintentos)
            useEffect(() => {
                let attempts = 0;
                const maxAttempts = 20; // 2 segundos max

                const initSupabase = () => {
                    try {
                        const lib = window.supabase || window.Supabase;
                        if (lib && (lib.createClient || (lib.default && lib.default.createClient))) {
                            const createClient = lib.createClient || lib.default.createClient;
                            if (SUPABASE_URL && SUPABASE_URL.startsWith('http')) {
                                const client = createClient(SUPABASE_URL, SUPABASE_KEY);
                                setSupabaseInstance(client);
                                return true;
                            }
                        }
                    } catch (e) {
                        console.warn("Intento de carga fallido:", e);
                    }
                    return false;
                };

                if (!initSupabase()) {
                    const interval = setInterval(() => {
                        attempts++;
                        if (initSupabase()) {
                            clearInterval(interval);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            setInitError("No se pudo cargar la librería Supabase tras varios intentos.");
                        }
                    }, 100);
                    return () => clearInterval(interval);
                }
            }, []);

            // Efecto de Sesión
            useEffect(() => {
                if (supabaseInstance) {
                    supabaseInstance.auth.getSession().then(({ data: { session } }) => setSession(session));
                    const { data: { subscription } } = supabaseInstance.auth.onAuthStateChange((_event, session) => setSession(session));
                    return () => subscription.unsubscribe();
                }
            }, [supabaseInstance]);

            if (!supabaseInstance) {
                return <ConfigRequired error={initError} />;
            }

            if (!session) return <AuthView supabaseInstance={supabaseInstance} />;

            return (
                <div className="min-h-screen pb-16 md:pb-0">
                    {/* Contenido */}
                    {view === 'dashboard' && <DashboardView userId={session.user.id} supabaseInstance={supabaseInstance} />}
                    {view === 'services' && <ServicesView userId={session.user.id} supabaseInstance={supabaseInstance} />}
                    {view === 'stats' && <StatsView supabaseInstance={supabaseInstance} />}

                    {/* Navbar */}
                    <nav className="fixed bottom-0 w-full bg-white border-t z-50 md:top-0 md:bottom-auto">
                        <div className="flex justify-around items-center h-16 max-w-4xl mx-auto">
                            <button onClick={() => setView('dashboard')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view==='dashboard'?'text-primary font-bold':'text-gray-400 hover:bg-gray-50'}`}>
                                <IconDashboard /><span className="text-xs">Pagos</span>
                            </button>
                            <button onClick={() => setView('services')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view==='services'?'text-primary font-bold':'text-gray-400 hover:bg-gray-50'}`}>
                                <IconServices /><span className="text-xs">Servicios</span>
                            </button>
                            <button onClick={() => setView('stats')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view==='stats'?'text-primary font-bold':'text-gray-400 hover:bg-gray-50'}`}>
                                <IconStats /><span className="text-xs">Gráficos</span>
                            </button>
                            <button onClick={() => supabaseInstance.auth.signOut()} className="flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-danger hover:bg-red-50 transition-colors">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                <span className="text-xs">Salir</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
