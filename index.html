<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pagos Familiar</title>
    
    <!-- FAVICON: Dinero con alas para un identificador visual r치pido -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游눶</text></svg>">
    
    <!-- 1. REACT Y REACTDOM DEBEN CARGARSE PRIMERO -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 2. DEPENDENCIAS PRINCIPALES (que no dependen de React o Babel) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    
    <!-- 3. DEPENDENCIAS DE REACT (prop-types debe ir antes de Recharts) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <!-- 4. BABEL STANDALONE (Debe ser la 칰ltima antes de tu c칩digo) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURACI칍N
        // ==========================================
        const SUPABASE_URL = 'https://sgqmpshjycbprifpxztl.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncW1wc2hqeWNicHJpZnB4enRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTYwNjQsImV4cCI6MjA4MTQ5MjA2NH0.mhae-9WuVGlXZwKlqUvplWGtlwbiEubSWo5MELnyWQk';
        
        const { useState, useEffect, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = window.Recharts || {};

        // ==========================================
        // HELPER: Formateo de Moneda (Acepta centavos)
        // ==========================================
        const formatCurrency = (amount) => {
            const num = parseFloat(amount) || 0;
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS', // Pesos Argentinos
                minimumFractionDigits: 2,
            }).format(num);
        };

        // ==========================================
        // COMPONENTES DE ICONOS
        // ==========================================
        const IconDashboard = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>;
        const IconServices = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>;
        const IconStats = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>;
        const IconCheck = () => <svg className="w-8 h-8 text-success" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>;
        const IconCircle = () => <svg className="w-8 h-8 text-gray-300 hover:text-primary transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth="2" /></svg>;
        const IconTrash = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const IconEdit = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const IconSave = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;

        // ==========================================
        // VISTA: PANTALLA DE ERROR/CONFIG
        // ==========================================
        const ConfigRequired = ({ error }) => (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50">
                <div className="card p-8 w-full max-w-lg border-l-8 border-yellow-400">
                    <h1 className="text-2xl font-bold text-gray-800 mb-4">丘멆잺 Cargando Aplicaci칩n</h1>
                    {error ? (
                         <div className="mb-4">
                            <p className="text-red-600 font-bold">Problema de conexi칩n:</p>
                            <p className="text-gray-600 text-sm">{error}</p>
                            <p className="mt-2 text-xs text-gray-500">
                                Estamos intentando conectar con los servidores de Supabase...
                            </p>
                         </div>
                    ) : (
                        <p className="text-gray-600 animate-pulse">Iniciando sistema...</p>
                    )}
                </div>
            </div>
        );

        // ==========================================
        // VISTA: LOGIN
        // ==========================================
        const AuthView = ({ supabaseInstance }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const { data, error } = await supabaseInstance.auth.signInWithPassword({ email, password });
                if (error) {
                    const { error: upError } = await supabaseInstance.auth.signUp({ email, password });
                    if (upError) setMsg('Error: ' + error.message);
                    else setMsg('Cuenta creada! Revisa tu email o inicia sesi칩n.');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <h1 className="text-2xl font-bold text-center text-primary mb-6">Mis Pagos</h1>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full p-3 border rounded-lg" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input type="password" placeholder="Contrase침a" className="w-full p-3 border rounded-lg" value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button disabled={loading} className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">
                                {loading ? 'Cargando...' : 'Entrar / Registrarse'}
                            </button>
                            {msg && <p className="text-center text-sm text-gray-500 mt-2">{msg}</p>}
                        </form>
                    </div>
                </div>
            );
        };

        // ==========================================
        // VISTA: SERVICIOS (Con Edici칩n)
        // ==========================================
        const ServicesView = ({ userId, supabaseInstance }) => {
            const [services, setServices] = useState([]);
            const [form, setForm] = useState({ name: '', day: 10, isCC: false });
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', default_due_day: 10, is_credit_card: false });

            useEffect(() => { loadServices() }, []);

            const loadServices = async () => {
                const { data } = await supabaseInstance.from('services').select('*').order('created_at');
                setServices(data || []);
            };

            const addService = async (e) => {
                e.preventDefault();
                await supabaseInstance.from('services').insert([{ 
                    user_id: userId, name: form.name, default_due_day: form.day, is_credit_card: form.isCC 
                }]);
                setForm({ name: '', day: 10, isCC: false });
                loadServices();
            };

            const startEdit = (s) => {
                setEditingId(s.id);
                setEditForm({ name: s.name, default_due_day: s.default_due_day, is_credit_card: s.is_credit_card });
            };

            const saveEdit = async (id) => {
                await supabaseInstance.from('services').update({
                    name: editForm.name,
                    default_due_day: editForm.default_due_day,
                    is_credit_card: editForm.is_credit_card
                }).eq('id', id);
                setEditingId(null);
                loadServices();
            };

            const deleteService = async (id) => {
                if(confirm("쮹orrar este servicio?")) {
                    await supabaseInstance.from('services').delete().eq('id', id);
                    loadServices();
                }
            };

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-2xl mx-auto fade-in">
                    <h2 className="text-xl font-bold mb-4">Configurar Servicios</h2>
                    
                    {/* Formulario de Alta */}
                    <form onSubmit={addService} className="card p-4 mb-6 grid gap-4 bg-blue-50 border border-blue-100">
                        <h3 className="text-sm font-bold text-blue-800 uppercase">Nuevo Servicio</h3>
                        <input type="text" placeholder="Nombre (ej: Netflix)" className="w-full p-2 border rounded" 
                            value={form.name} onChange={e => setForm({...form, name: e.target.value})} required />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="text-xs text-gray-500">D칤a vencimiento</label>
                                <input type="number" min="1" max="31" className="w-full p-2 border rounded" 
                                    value={form.day} onChange={e => setForm({...form, day: e.target.value})} />
                            </div>
                            <div className="flex items-center gap-2 pt-4">
                                <input type="checkbox" checked={form.isCC} onChange={e => setForm({...form, isCC: e.target.checked})} className="w-5 h-5 rounded text-primary focus:ring-primary" />
                                <label className="text-sm">Es Tarjeta de Cr칠dito</label>
                            </div>
                        </div>
                        <button className="bg-primary text-white py-2 rounded font-medium hover:bg-blue-600 transition">Agregar</button>
                    </form>

                    {/* Lista de Servicios */}
                    <div className="space-y-3">
                        {services.map(s => (
                            <div key={s.id} className="card p-4 flex flex-col gap-3 border-l-4 border-primary hover:shadow-md transition">
                                {editingId === s.id ? (
                                    // Modo Edici칩n
                                    <div className="flex flex-col gap-3">
                                        <input type="text" className="border p-2 rounded" value={editForm.name} onChange={e=>setEditForm({...editForm, name: e.target.value})} />
                                        <div className="flex gap-4 items-center">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-gray-500">D칤a:</span>
                                                <input type="number" className="border p-1 rounded w-16" value={editForm.default_due_day} onChange={e=>setEditForm({...editForm, default_due_day: e.target.value})} />
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <input type="checkbox" checked={editForm.is_credit_card} onChange={e=>setEditForm({...editForm, is_credit_card: e.target.checked})} />
                                                <span className="text-xs text-gray-500">Tarjeta</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end">
                                            <button onClick={()=>setEditingId(null)} className="text-gray-500 text-sm px-3 py-1">Cancelar</button>
                                            <button onClick={()=>saveEdit(s.id)} className="bg-green-600 text-white px-3 py-1 rounded text-sm flex items-center gap-1"><IconSave /> Guardar</button>
                                        </div>
                                    </div>
                                ) : (
                                    // Modo Visualizaci칩n
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="font-bold">{s.name}</h3>
                                            <p className="text-xs text-gray-500">Vence d칤a {s.default_due_day} {s.is_credit_card ? '(Tarjeta)' : ''}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => startEdit(s)} className="text-gray-400 hover:text-blue-500 p-2"><IconEdit /></button>
                                            <button onClick={() => deleteService(s.id)} className="text-gray-400 hover:text-danger p-2"><IconTrash /></button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // COMPONENTE: ITEM DE PAGO (Controla su propio estado)
        // ==========================================
        const PaymentItem = ({ item, userId, date, onUpdate, supabaseInstance }) => {
            // Estado local para evitar re-renderizados masivos al escribir. 
            // Representa el monto que el usuario est치 definiendo para pagar/actualizar.
            const [localAmount, setLocalAmount] = useState('');
            // Estado para controlar si es un pago parcial (solo para CC)
            const [isPartialPay, setIsPartialPay] = useState(false); 

            // Sincronizar estado local si cambian las props
            useEffect(() => {
                // Si el item est치 pagado, muestra lo que se pag칩. 
                // Si no, muestra lo que se debe (amount_due).
                const initialValue = item.is_paid ? item.amount_paid : item.amount_due;
                setLocalAmount(initialValue ? parseFloat(initialValue).toFixed(2) : '0.00');
                // Al cambiar de 칤tem o al iniciar, resetear el check de pago parcial.
                setIsPartialPay(false); 
            }, [item.amount_due, item.amount_paid, item.is_paid, item.id]); // Added item.id dependency

            const handleBlur = async () => {
                const parsedAmount = parseFloat(localAmount);
                if (isNaN(parsedAmount) || parsedAmount < 0) {
                    setLocalAmount('0.00');
                    return;
                }

                const newAmount = parsedAmount.toFixed(2);
                setLocalAmount(newAmount);
                
                // Si NO est치 pagado:
                // Esto maneja la edici칩n del monto total a pagar (amount_due) antes de marcarlo como pagado, 
                // tanto para CC (factura variable) como para servicios normales.
                if (!item.is_paid && newAmount !== parseFloat(item.amount_due).toFixed(2)) {
                    await onUpdate(item, { amount_due: newAmount });
                }
            };

            const togglePaid = async () => {
                const newStatus = !item.is_paid;
                
                if (newStatus === true) {
                    let amountToPay = parseFloat(localAmount);

                    if (item.is_credit_card && !isPartialPay) {
                        // Pago Total: usa el monto total adeudado del 칤tem, ignorando el input local 
                        // si es diferente (aunque el input ya fue actualizado por blur).
                        amountToPay = parseFloat(item.amount_due);
                        // Aseguramos que el input se sincronice con el pago total si no estaba en modo parcial
                        setLocalAmount(amountToPay.toFixed(2));
                    } 
                    
                    amountToPay = Math.max(0, amountToPay);

                    await onUpdate(item, { 
                        is_paid: true, 
                        amount_paid: amountToPay.toFixed(2), 
                    });
                } else {
                    // L칍GICA DE DESMARCAR (Quitar el check)
                    // Si el 칤tem ya ten칤a un payment_id, lo eliminamos de la base de datos.
                    if (item.payment_id) {
                         // Llamada directa a Supabase para eliminar el registro de pago.
                         await supabaseInstance.from('payments').delete().eq('id', item.payment_id);
                         
                         // Forzar el refresh despu칠s de la eliminaci칩n.
                         await onUpdate({}, {}); 
                    } else {
                        // Si no tiene payment_id, actualizamos localmente.
                        await onUpdate(item, { 
                            is_paid: false, 
                            amount_paid: 0,
                        });
                    }
                }
            };
            
            const remainingBalance = parseFloat(item.amount_due) - parseFloat(item.amount_paid);

            return (
                <div className={`card p-4 border-l-4 transition-all ${item.is_paid ? 'border-success opacity-70' : item.skipped ? 'border-gray-300 opacity-50 grayscale' : 'border-primary'}`}>
                    <div className="flex justify-between mb-2">
                        <div>
                            <h3 className={`font-bold ${item.skipped ? 'line-through':''}`}>{item.name}</h3>
                            <p className="text-xs text-gray-500">Vence: D칤a {item.default_due_day}</p>
                            {/* Mostrar el carry over si existe */}
                            {item.carry_over_amount > 0 && (
                                <p className="text-xs text-orange-500 font-medium mt-1">
                                    Deuda arrastrada: {formatCurrency(item.carry_over_amount)}
                                </p>
                            )}
                        </div>
                        <button onClick={() => onUpdate(item, { skipped: !item.skipped })} className="text-xs bg-gray-100 px-2 py-1 rounded h-fit hover:bg-gray-200">
                            {item.skipped ? 'Activar' : 'Saltar'}
                        </button>
                    </div>
                    
                    {!item.skipped && (
                        <>
                            {item.is_credit_card && !item.is_paid && (
                                <div className="flex items-center gap-2 mb-2">
                                    <input 
                                        type="checkbox" 
                                        checked={isPartialPay} 
                                        onChange={e => {
                                            const newIsPartialPay = e.target.checked;
                                            setIsPartialPay(newIsPartialPay);
                                            
                                            // Al marcar/desmarcar parcial, el input debe reflejar el monto total para edici칩n.
                                            setLocalAmount(parseFloat(item.amount_due).toFixed(2));
                                        }} 
                                        className="w-4 h-4 rounded text-primary focus:ring-primary" 
                                        id={`partial-pay-${item.id}`}
                                    />
                                    <label htmlFor={`partial-pay-${item.id}`} className="text-sm text-gray-600">Pago Parcial (editar para pagar menos)</label>
                                </div>
                            )}

                            <div className="flex items-end gap-3">
                                <div className="flex-1">
                                    {/* Etiqueta eliminada, solo queda el monto total a pagar como referencia */}
                                    <span className="text-xs uppercase font-bold text-gray-400">
                                        Total Adeudado: {formatCurrency(item.amount_due)}
                                    </span>
                                    <input 
                                        type="number" 
                                        step="0.01" // Acepta centavos
                                        className="w-full text-lg font-bold border-b border-gray-200 outline-none bg-transparent focus:border-primary"
                                        placeholder="0.00" 
                                        value={localAmount}
                                        onChange={(e) => setLocalAmount(e.target.value)}
                                        onBlur={handleBlur}
                                        onKeyDown={(e) => e.key === 'Enter' && e.target.blur()}
                                        // El input es editable siempre que no est칠 pagado
                                        disabled={item.is_paid}
                                    />
                                </div>
                                
                                <button onClick={togglePaid} className="transition-transform active:scale-95">
                                    {item.is_paid ? <IconCheck /> : (
                                        item.is_credit_card && !isPartialPay ? (
                                            // Pagar Total para CC
                                            <span className="bg-primary text-white text-xs px-3 py-1.5 rounded-full h-[38px] flex items-center justify-center font-bold hover:bg-blue-600 transition-transform">Pagar Total</span>
                                        ) : (
                                            // Pagar Parcial CC o Pago Simple
                                            <IconCircle />
                                        )
                                    )}
                                </button>
                            </div>
                        </>
                    )}
                    
                    {/* Mostrar saldo pendiente para CC si fue pago parcial */}
                    {item.is_paid && item.is_credit_card && remainingBalance > 0.01 && (
                         <p className="text-xs text-red-500 font-medium mt-2 p-1 bg-red-50 rounded">
                             Saldo pendiente (se arrastra al pr칩ximo mes): {formatCurrency(remainingBalance)}
                         </p>
                    )}
                </div>
            );
        };

        // ==========================================
        // VISTA: DASHBOARD
        // ==========================================
        const DashboardView = ({ userId, supabaseInstance }) => {
            const [date, setDate] = useState(new Date());
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshKey, setRefreshKey] = useState(0); // Estado para forzar refresco

            useEffect(() => { loadData() }, [date, refreshKey]); // Dependencia del refreshKey

            const loadData = async () => {
                setLoading(true);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                // 1. Calcular mes y a침o anterior para buscar deuda arrastrada (carry-over)
                let prevMonth = month - 1;
                let prevYear = year;
                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear = year - 1;
                }

                // Obtener datos
                const { data: services } = await supabaseInstance.from('services').select('*').eq('active', true);
                const { data: payments } = await supabaseInstance.from('payments').select('*').eq('month', month).eq('year', year);
                const { data: prevPayments } = await supabaseInstance.from('payments').select('*').eq('month', prevMonth).eq('year', prevYear);

                if (services) {
                    const merged = services.map(svc => {
                        const pay = payments?.find(p => p.service_id === svc.id);
                        
                        let currentAmountDue = parseFloat(pay?.amount_due) || 0; // Monto esperado original del mes
                        let carryOver = 0;
                        
                        // L칩gica de arrastre de deuda (solo CC)
                        if (svc.is_credit_card) {
                            const prevPay = prevPayments?.find(p => p.service_id === svc.id);
                            
                            if (prevPay && prevPay.is_paid) {
                                // Saldo remanente (amount_due - amount_paid)
                                const remainingBalance = (parseFloat(prevPay.amount_due) || 0) - (parseFloat(prevPay.amount_paid) || 0);
                                if (remainingBalance > 0.01) { // Usar 0.01 para evitar problemas de float
                                    carryOver = remainingBalance;
                                    currentAmountDue = (currentAmountDue) + carryOver; // Sumar la deuda al monto esperado
                                }
                            }
                        }

                        // amount_due es el total a pagar (original + arrastre)
                        return {
                            ...svc,
                            payment_id: pay?.id, // ID del registro de pago para eliminaci칩n
                            amount_due: currentAmountDue.toFixed(2), // Total a pagar, incluyendo carryOver (para CC)
                            amount_paid: parseFloat(pay?.amount_paid || 0).toFixed(2),
                            is_paid: pay?.is_paid || false,
                            skipped: pay?.skipped || false,
                            carry_over_amount: carryOver,
                            is_credit_card: svc.is_credit_card
                        };
                    });
                    
                    // 2. L칩gica de Ordenamiento: Pendientes por fecha (asc), Pagados al final
                    const sortedItems = merged.sort((a, b) => {
                        // Pagados van al final (true es mayor que false)
                        if (a.is_paid !== b.is_paid) {
                            return a.is_paid ? 1 : -1; // Pagado (1) va al final, No Pagado (-1) va al inicio
                        }

                        // 칈tems sin pagar (o pagados): ordenar por fecha de vencimiento (m치s cercano primero)
                        return a.default_due_day - b.default_due_day;
                    });
                    
                    setItems(sortedItems);
                }
                setLoading(false);
            };
            
            // Los c치lculos de totales deben usar los valores actuales del estado, que ya tienen el carry-over incluido.
            const totalDue = items.filter(i => !i.skipped).reduce((acc, c) => acc + parseFloat(c.amount_due), 0);
            const totalPaid = items.filter(i => !i.skipped && i.is_paid).reduce((acc, c) => acc + parseFloat(c.amount_paid), 0); // Usamos amount_paid real
            const remaining = totalDue - totalPaid;

            const updatePayment = async (item, updates) => {
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                let payload = {
                    service_id: item.id,
                    user_id: userId,
                    month,
                    year,
                    // Campos actuales (los usamos como base)
                    amount_due: parseFloat(item.amount_due) || 0,
                    amount_paid: parseFloat(item.amount_paid) || 0,
                    is_paid: item.is_paid,
                    skipped: item.skipped,
                };

                // Sobrescribir con las actualizaciones
                Object.keys(updates).forEach(key => {
                    if (key === 'amount_due' || key === 'amount_paid') {
                        payload[key] = parseFloat(updates[key]) || 0;
                    } else {
                        payload[key] = updates[key];
                    }
                });
                
                // 1. Actualizaci칩n Optimista + Reordenamiento Local
                setItems(prevItems => 
                    prevItems.map(i => 
                        i.id === item.id 
                            ? { 
                                ...i, 
                                is_paid: payload.is_paid, // Usa el nuevo estado
                                amount_paid: payload.amount_paid, // Usa el nuevo monto pagado
                                amount_due: payload.amount_due, // Usa el nuevo monto adeudado (importante para edici칩n)
                              } 
                            : i
                    ).sort((a, b) => { // Re-sort inmediatamente localmente
                        if (a.is_paid !== b.is_paid) {
                            return a.is_paid ? 1 : -1;
                        }
                        return a.default_due_day - b.default_due_day;
                    })
                );

                // 2. Manejo de la base de datos: Upsert/Update
                
                // Determinar si ya existe un registro de pago para este mes y servicio
                const paymentIdToUpdate = item.payment_id;

                if (paymentIdToUpdate) {
                     // Si existe un registro, lo actualizamos.
                    await supabaseInstance.from('payments').update(payload).eq('id', paymentIdToUpdate);
                } else {
                    // Si no existe, lo insertamos/creamos.
                    const { data: inserted } = await supabaseInstance.from('payments').insert(payload).select();
                    
                     // Si insertamos un nuevo pago, necesitamos el ID para futuras eliminaciones/actualizaciones.
                    if (inserted && inserted.length > 0) {
                         setItems(prevItems => 
                             prevItems.map(i => i.id === item.id ? { ...i, payment_id: inserted[0].id } : i)
                         );
                    }
                }
                
                // 3. Failsafe Full Data Reload
                setRefreshKey(prev => prev + 1);
            };

            const changeMonth = (delta) => {
                const d = new Date(date);
                d.setMonth(d.getMonth() + delta);
                setDate(d);
            };

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-4xl mx-auto fade-in">
                    <div className="flex justify-between items-center mb-6 card p-3">
                        <button onClick={() => changeMonth(-1)} className="p-2 font-bold text-xl hover:bg-gray-100 rounded">&lt;</button>
                        <h2 className="text-xl font-bold capitalize">{date.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 font-bold text-xl hover:bg-gray-100 rounded">&gt;</button>
                    </div>

                    <div className="grid grid-cols-3 gap-2 mb-6 text-center">
                        <div className="bg-blue-100 p-2 rounded text-blue-800">
                            <div className="text-xs uppercase font-bold">Total Due</div>
                            <div className="font-bold text-lg">{formatCurrency(totalDue)}</div>
                        </div>
                        <div className="bg-green-100 p-2 rounded text-green-800">
                            <div className="text-xs uppercase font-bold">Pagado</div>
                            <div className="font-bold text-lg">{formatCurrency(totalPaid)}</div>
                        </div>
                        <div className="bg-red-100 p-2 rounded text-red-800 border border-red-200">
                            <div className="text-xs uppercase font-bold">Resta</div>
                            <div className="font-bold text-lg">{formatCurrency(remaining)}</div>
                        </div>
                    </div>

                    <div className="space-y-3">
                        {loading ? <div className="text-center p-4 text-gray-500">Cargando...</div> : items.map(item => (
                            <PaymentItem 
                                key={item.id} 
                                item={item} 
                                userId={userId} 
                                date={date} 
                                onUpdate={updatePayment} 
                                supabaseInstance={supabaseInstance}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // VISTA: ESTAD칈STICAS
        // ==========================================
        const StatsView = ({ supabaseInstance }) => {
            const [data, setData] = useState([]);

            useEffect(() => {
                const calc = async () => {
                    const year = new Date().getFullYear();
                    // Usamos amount_paid ya que es el monto real pagado (importante para CC parciales)
                    const { data: payments } = await supabaseInstance.from('payments').select('month, amount_paid').eq('year', year).eq('is_paid', true);
                    
                    const chartData = Array.from({length: 12}, (_, i) => {
                        const m = i + 1;
                        const total = payments?.filter(p => p.month === m).reduce((acc, c) => acc + parseFloat(c.amount_paid), 0) || 0;
                        return { name: new Date(2024, i, 1).toLocaleString('es-ES', {month:'short'}), total };
                    });
                    setData(chartData);
                };
                calc();
            }, []);

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-4xl mx-auto h-screen flex flex-col fade-in">
                    <h2 className="text-xl font-bold mb-4">Gastos Anuales</h2>
                    <div className="card p-4 flex-1 max-h-[500px]">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={data}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                <YAxis 
                                    axisLine={false} 
                                    tickLine={false} 
                                    // Usar el formato de moneda en el eje Y
                                    tickFormatter={(value) => formatCurrency(value)} 
                                />
                                <Tooltip formatter={(value) => [formatCurrency(value), 'Total Pagado']} />
                                <Bar dataKey="total" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        // ==========================================
        // APP PRINCIPAL
        // ==========================================
        const App = () => {
            const [supabaseInstance, setSupabaseInstance] = useState(null);
            const [session, setSession] = useState(null);
            const [view, setView] = useState('dashboard');
            const [initError, setInitError] = useState(null);

            // Efecto de Inicializaci칩n con Polling (Reintentos)
            useEffect(() => {
                let attempts = 0;
                const maxAttempts = 20; // 2 segundos max

                const initSupabase = () => {
                    try {
                        const lib = window.supabase || window.Supabase;
                        if (lib && (lib.createClient || (lib.default && lib.default.createClient))) {
                            const createClient = lib.createClient || lib.default.createClient;
                            if (SUPABASE_URL && SUPABASE_URL.startsWith('http')) {
                                const client = createClient(SUPABASE_URL, SUPABASE_KEY);
                                setSupabaseInstance(client);
                                return true;
                            }
                        }
                    } catch (e) {
                        console.warn("Intento de carga fallido:", e);
                    }
                    return false;
                };

                if (!initSupabase()) {
                    const interval = setInterval(() => {
                        attempts++;
                        if (initSupabase()) {
                            clearInterval(interval);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            setInitError("No se pudo cargar la librer칤a Supabase tras varios intentos.");
                        }
                    }, 100);
                    return () => clearInterval(interval);
                }
            }, []);

            // Efecto de Sesi칩n
            useEffect(() => {
                if (supabaseInstance) {
                    supabaseInstance.auth.getSession().then(({ data: { session } }) => setSession(session));
                    const { data: { subscription } } = supabaseInstance.auth.onAuthStateChange((_event, session) => setSession(session));
                    return () => subscription.unsubscribe();
                }
            }, [supabaseInstance]);

            if (!supabaseInstance) {
                return <ConfigRequired error={initError} />;
            }

            if (!session) return <AuthView supabaseInstance={supabaseInstance} />;

            return (
                <div className="min-h-screen pb-16 md:pb-0">
                    {/* Contenido */}
                    {view === 'dashboard' && <DashboardView userId={session.user.id} supabaseInstance={supabaseInstance} />}
                    {view === 'services' && <ServicesView userId={session.user.id} supabaseInstance={supabaseInstance} />}
                    {view === 'stats' && <StatsView supabaseInstance={supabaseInstance} />}

                    {/* Navbar */}
                    <nav className="fixed bottom-0 w-full bg-white border-t z-50 md:top-0 md:bottom-auto">
                        <div className="flex justify-around items-center h-16 max-w-4xl mx-auto">
                            <button onClick={() => setView('dashboard')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view==='dashboard'?'text-primary font-bold':'text-gray-400 hover:bg-gray-50'}`}>
                                <IconDashboard /><span className="text-xs">Pagos</span>
                            </button>
                            <button onClick={() => setView('services')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view==='services'?'text-primary font-bold':'text-gray-400 hover:bg-gray-50'}`}>
                                <IconServices /><span className="text-xs">Servicios</span>
                            </button>
                            <button onClick={() => setView('stats')} className={`flex flex-col items-center p-2 rounded-lg transition-colors ${view==='stats'?'text-primary font-bold':'text-gray-400 hover:bg-gray-50'}`}>
                                <IconStats /><span className="text-xs">Gr치ficos</span>
                            </button>
                            <button onClick={() => supabaseInstance.auth.signOut()} className="flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-danger hover:bg-red-50 transition-colors">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                <span className="text-xs">Salir</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
