<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mis Pagos Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; touch-action: manipulation; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 16px; }
        .paid-item { opacity: 0.6; background-color: #f0fdf4; }
        
        #loadingOverlay {
            position: fixed; inset: 0; background: #4338ca; z-index: 50; 
            display: flex; flex-direction: column; justify-content: center; items-center; color: white;
            transition: opacity 0.3s;
        }
        
        /* LOG EN PANTALLA (Para ver qué pasa) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0; height: 120px;
            background: rgba(0,0,0,0.85); color: #00ff00; font-family: monospace;
            font-size: 10px; overflow-y: auto; padding: 10px; z-index: 9999;
            border-top: 2px solid #333; pointer-events: none;
        }
    </style>
</head>
<body class="pb-40 select-none">

    <div id="loadingOverlay">
        <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
        <p class="font-bold text-lg" id="loadingText">Iniciando...</p>
        <button onclick="hardReset()" class="mt-8 bg-red-600 text-white px-4 py-2 rounded text-xs border border-red-400">
            ¿Trabado? Clic aquí para Reiniciar
        </button>
    </div>

    <div id="appUI" class="hidden">
        <div class="bg-indigo-700 text-white rounded-b-3xl shadow-lg sticky top-0 z-20 pt-safe">
            <div class="flex justify-between items-center p-4 border-b border-indigo-600">
                <button onclick="changeMonth(-1)" class="p-2"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthLabel" class="text-xl font-bold capitalize"></h2>
                <button onclick="changeMonth(1)" class="p-2"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="p-6 pt-4 flex justify-between items-end">
                <div><p class="text-indigo-200 text-sm">Resta Pagar</p><p class="text-4xl font-bold" id="totalRemaining">$0,00</p></div>
                <div class="text-right"><p class="text-indigo-200 text-xs">Total Gastado</p><p class="text-xl font-semibold" id="totalSpent">$0,00</p></div>
            </div>
        </div>

        <div class="p-4 max-w-md mx-auto">
            <div class="flex bg-gray-200 p-1 rounded-xl mb-6">
                <button onclick="showSection('list')" id="btn-list" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow text-indigo-700">Pagos</button>
                <button onclick="showSection('add')" id="btn-add" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500">Servicios</button>
                <button onclick="showSection('stats')" id="btn-stats" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500">Gráficos</button>
            </div>

            <div id="section-list">
                <div class="w-full bg-gray-300 rounded-full h-2.5 mb-6"><div id="progressBar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                <div id="emptyState" class="hidden text-center py-10 opacity-50"><i class="fas fa-check-circle text-4xl mb-2"></i><p>Todo al día</p></div>
                <div id="pendingList"></div>
                <div id="completedList" class="mt-8 border-t pt-4"></div>
            </div>

            <div id="section-add" class="hidden">
                <div class="card border-l-4 border-indigo-500 mb-6">
                    <h3 class="font-bold mb-4">Nuevo Servicio</h3>
                    <form id="addForm" onsubmit="handleFormSubmit(event)">
                        <input type="hidden" id="editingId">
                        <input type="text" id="serviceName" placeholder="Nombre" class="w-full bg-gray-50 p-3 rounded mb-3 border" required>
                        <input type="number" id="serviceDay" placeholder="Día Vencimiento" class="w-full bg-gray-50 p-3 rounded mb-3 border" required>
                        <div class="flex items-center mb-4"><input type="checkbox" id="isCreditCard" class="mr-2"><label>Es Tarjeta</label></div>
                        <button type="submit" class="w-full bg-indigo-700 text-white py-3 rounded font-bold">Guardar</button>
                    </form>
                </div>
                <div id="servicesList"></div>
            </div>

            <div id="section-stats" class="hidden">
                <div class="card"><canvas id="expenseChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="debug-console"></div>

    <script>
        // --- 1. CONFIGURACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyBk-LaNtS15CYhycTl7w6w9xmrVxM88L-M",
            authDomain: "pagos-6f294.firebaseapp.com",
            projectId: "pagos-6f294",
            storageBucket: "pagos-6f294.firebasestorage.app",
            messagingSenderId: "835956011658",
            appId: "1:835956011658:web:cf1cb8331e22b5bab37373"
        };

        // --- SISTEMA DE LOGS VISUALES ---
        function log(msg) {
            console.log(msg);
            const line = document.createElement('div');
            line.innerText = "> " + msg;
            document.getElementById('debug-console').prepend(line);
            document.getElementById('loadingText').innerText = msg;
        }

        // --- INICIALIZACIÓN ---
        let db, auth;
        let currentUser = null;
        let viewedDate = new Date();
        let services = [], payments = {};
        let loadTimeout;

        try {
            log("Inicializando Firebase...");
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Timeout de seguridad: si en 8 seg no carga, avisa.
            loadTimeout = setTimeout(() => {
                log("⚠️ TIEMPO DE ESPERA AGOTADO. Revisa tu conexión.");
                alert("La conexión está muy lenta o bloqueada. Intenta recargar.");
            }, 8000);

            log("Autenticando...");
            auth.signInAnonymously()
                .then(userCred => {
                    currentUser = userCred.user;
                    log("✅ Login OK: " + currentUser.uid.slice(0,5));
                    loadData();
                })
                .catch(e => log("❌ ERROR LOGIN: " + e.message));

        } catch (e) {
            log("❌ ERROR FATAL: " + e.message);
        }

        function loadData() {
            log("Descargando datos...");
            const docRef = db.collection("users").doc(currentUser.uid).collection("appData").doc("main");

            docRef.get().then(doc => {
                clearTimeout(loadTimeout); // Cancelar alerta de timeout
                if (doc.exists) {
                    log("Datos recibidos.");
                    const data = doc.data();
                    services = data.services || [];
                    payments = data.payments || {};
                } else {
                    log("Usuario nuevo. Creando base...");
                    services = [];
                    payments = {};
                    saveData(false);
                }
                iniciarApp();
            }).catch(e => {
                log("❌ ERROR LECTURA: " + e.message);
                if(e.code === 'permission-denied') alert("Error de Permisos. Revisa las reglas en Firebase.");
            });
        }

        function saveData(silent = true) {
            if(!currentUser) return;
            if(!silent) log("Guardando...");
            db.collection("users").doc(currentUser.uid).collection("appData").doc("main")
              .set({ services, payments, lastUpdate: new Date().toISOString() })
              .then(() => { if(!silent) log("Guardado OK"); })
              .catch(e => log("❌ Error Guardado: " + e.message));
        }

        function iniciarApp() {
            log("Iniciando Interfaz...");
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('appUI').classList.remove('hidden');
            renderUI();
            log("Listo. App activa.");
            setTimeout(() => document.getElementById('debug-console').style.display = 'none', 3000); // Ocultar consola a los 3 seg
        }

        // --- LÓGICA UI ---
        const AR_CURRENCY = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' });
        function formatMoney(n) { return AR_CURRENCY.format(n); }
        function getMonthKey(d) { return d.toISOString().slice(0, 7); }

        function renderUI() {
            const key = getMonthKey(viewedDate);
            document.getElementById('currentMonthLabel').innerText = viewedDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            
            // Generar pagos si faltan
            if(!payments[key]) {
                payments[key] = [];
                services.forEach(s => payments[key].push({
                    id: Date.now() + Math.random(), serviceId: s.id, name: s.name, 
                    amount: 0, totalBill: 0, paid: false, 
                    dueDate: `${key}-${String(s.day).padStart(2,'0')}`, 
                    isCreditCard: s.isCreditCard, paymentType: 'total'
                }));
            }

            // Listas
            const list = payments[key];
            const pending = document.getElementById('pendingList');
            const completed = document.getElementById('completedList');
            pending.innerHTML = ''; completed.innerHTML = '';
            
            let total = 0, spent = 0;

            list.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach((p, idx) => {
                total += (p.amount || 0);
                if(p.paid) spent += (p.amount || 0);
                
                const div = document.createElement('div');
                div.className = `card ${p.paid ? 'paid-item' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between">
                        <div>
                            <div class="font-bold">${p.name}</div>
                            <div class="text-xs text-gray-500">${p.dueDate}</div>
                        </div>
                        <div onclick="togglePaid('${key}', ${idx})" class="w-8 h-8 rounded-full border flex items-center justify-center ${p.paid?'bg-green-500 text-white':'border-gray-300'}">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-400">IMPORTE</label>
                        <input type="number" value="${p.amount||''}" placeholder="0" 
                            onchange="updateAmount('${key}', ${idx}, this.value)"
                            class="text-right font-bold text-xl w-32 outline-none bg-transparent">
                    </div>
                `;
                if(p.paid) completed.appendChild(div); else pending.appendChild(div);
            });

            document.getElementById('totalRemaining').innerText = formatMoney(total - spent);
            document.getElementById('totalSpent').innerText = formatMoney(spent);
            document.getElementById('progressBar').style.width = total ? (spent/total*100)+'%' : '0%';
            document.getElementById('emptyState').className = list.length===0 ? 'text-center py-10 opacity-50' : 'hidden';
            
            if(document.getElementById('section-add').style.display !== 'none') renderServices();
        }

        // --- ACCIONES ---
        window.changeMonth = (d) => { viewedDate.setMonth(viewedDate.getMonth()+d); renderUI(); };
        window.showSection = (id) => {
            ['list','add','stats'].forEach(s => document.getElementById('section-'+s).classList.add('hidden'));
            document.getElementById('section-'+id).classList.remove('hidden');
            if(id === 'add') renderServices();
        };
        
        window.updateAmount = (k, i, v) => { payments[k][i].amount = parseFloat(v); saveData(); renderUI(); };
        window.togglePaid = (k, i) => { payments[k][i].paid = !payments[k][i].paid; saveData(); renderUI(); };

        // Servicios
        window.handleFormSubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('serviceName').value;
            const day = document.getElementById('serviceDay').value;
            const isCC = document.getElementById('isCreditCard').checked;
            services.push({ id: Date.now(), name, day, isCreditCard: isCC });
            saveData(); document.getElementById('addForm').reset(); renderServices();
        };
        
        function renderServices() {
            const div = document.getElementById('servicesList'); div.innerHTML = '';
            services.forEach(s => {
                div.innerHTML += `<div class="bg-white p-3 mb-2 rounded shadow flex justify-between"><span>${s.name} (Día ${s.day})</span> <button onclick="delService(${s.id})" class="text-red-500"><i class="fas fa-trash"></i></button></div>`;
            });
        }
        window.delService = (id) => { if(confirm('¿Borrar?')) { services = services.filter(s=>s.id!==id); saveData(); renderServices(); }};

        // Reset
        window.hardReset = () => {
            if(confirm("Esto reiniciará la app si está trabada. ¿Seguro?")) {
                localStorage.clear();
                window.location.reload();
            }
        };
    </script>
</body>
</html>
