<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pagos Familiar</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Ocultar flechas de input number */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Configuraci贸n de Supabase
        const SUPABASE_URL = 'https://sgqmpshjycbprifpxztl.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNncW1wc2hqeWNicHJpZnB4enRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTYwNjQsImV4cCI6MjA4MTQ5MjA2NH0.mhae-9WuVGlXZwKlqUvplWGtlwbiEubSWo5MELnyWQk';
        
        const { useState, useEffect, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, PieChart, Pie, Cell } = window.Recharts || {};

        const COLORS = ['#3b82f6', '#22c55e', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#10b981', '#f97316', '#6366f1'];

        const formatCurrency = (amount) => {
            const num = parseFloat(amount) || 0;
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 2,
            }).format(num);
        };

        const IconDashboard = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 0 012-2h2a2 0 012 2v2a2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 0 012-2h2a2 0 012 2v2a2 0 01-2 2h-2a2 0 01-2-2V6zM4 16a2 0 012-2h2a2 0 012 2v2a2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 0 012-2h2a2 0 012 2v2a2 0 01-2 2h-2a2 0 01-2-2v-2z" /></svg>;
        const IconServices = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 v2M7 7h10" /></svg>;
        const IconStats = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>;
        const IconCheck = () => <svg className="w-8 h-8 text-success" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>;
        const IconCircle = () => <svg className="w-8 h-8 text-gray-300 hover:text-primary transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth="2" /></svg>;
        const IconTrash = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const IconEdit = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const IconSave = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;

        const AuthView = ({ supabaseInstance }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const { data, error } = await supabaseInstance.auth.signInWithPassword({ email, password });
                if (error) {
                    const { error: upError } = await supabaseInstance.auth.signUp({ email, password });
                    if (upError) setMsg('Error: ' + error.message);
                    else setMsg('Cuenta creada! Revisa tu email o inicia sesi贸n.');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="card p-8 w-full max-w-md">
                        <h1 className="text-2xl font-bold text-center text-primary mb-6">Mis Pagos</h1>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="Email" className="w-full p-3 border rounded-lg" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input type="password" placeholder="Contrase帽a" className="w-full p-3 border rounded-lg" value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button disabled={loading} className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">
                                {loading ? 'Cargando...' : 'Entrar / Registrarse'}
                            </button>
                            {msg && <p className="text-center text-sm text-gray-500 mt-2">{msg}</p>}
                        </form>
                    </div>
                </div>
            );
        };

        const ServicesView = ({ userId, supabaseInstance, services, onRefresh }) => {
            const [form, setForm] = useState({ name: '', day: 10, isCC: false });
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', default_due_day: 10, is_credit_card: false });

            const addService = async (e) => {
                e.preventDefault();
                await supabaseInstance.from('services').insert([{ 
                    user_id: userId, 
                    name: form.name, 
                    default_due_day: parseInt(form.day), 
                    is_credit_card: form.isCC,
                    active: true
                }]);
                setForm({ name: '', day: 10, isCC: false });
                onRefresh();
            };

            const saveEdit = async (id) => {
                await supabaseInstance.from('services').update({
                    name: editForm.name,
                    default_due_day: parseInt(editForm.default_due_day),
                    is_credit_card: editForm.is_credit_card
                }).eq('id', id);
                setEditingId(null);
                onRefresh();
            };

            const deleteService = async (id) => {
                if(confirm("驴Borrar este servicio?")) {
                    await supabaseInstance.from('services').delete().eq('id', id);
                    onRefresh();
                }
            };

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-2xl mx-auto fade-in">
                    <h2 className="text-xl font-bold mb-4">Configurar Servicios</h2>
                    
                    <form onSubmit={addService} className="card p-4 mb-6 grid gap-4 bg-blue-50 border border-blue-100">
                        <h3 className="text-sm font-bold text-blue-800 uppercase">Nuevo Servicio</h3>
                        <input type="text" placeholder="Nombre (ej: Netflix)" className="w-full p-2 border rounded" 
                            value={form.name} onChange={e => setForm({...form, name: e.target.value})} required />
                        <div className="flex gap-4">
                            <div className="flex-1">
                                <label className="text-xs text-gray-500">D铆a vencimiento</label>
                                <input type="number" min="1" max="31" className="w-full p-2 border rounded" 
                                    value={form.day} onChange={e => setForm({...form, day: e.target.value})} />
                            </div>
                            <div className="flex items-center gap-2 pt-4">
                                <input type="checkbox" checked={form.isCC} onChange={e => setForm({...form, isCC: e.target.checked})} className="w-5 h-5 rounded text-primary" />
                                <label className="text-sm font-medium">Es Tarjeta de Cr茅dito</label>
                            </div>
                        </div>
                        <button className="bg-primary text-white py-2 rounded font-medium hover:bg-blue-600 transition">Agregar</button>
                    </form>

                    <div className="space-y-3">
                        {services.map(s => (
                            <div key={s.id} className="card p-4 border-l-4 border-primary">
                                {editingId === s.id ? (
                                    <div className="flex flex-col gap-3">
                                        <input type="text" className="border p-2 rounded w-full" value={editForm.name} onChange={e=>setEditForm({...editForm, name: e.target.value})} />
                                        <div className="flex gap-4 items-center">
                                            <input type="number" className="border p-1 rounded w-20" value={editForm.default_due_day} onChange={e=>setEditForm({...editForm, default_due_day: e.target.value})} />
                                            <div className="flex items-center gap-2">
                                                <input type="checkbox" checked={editForm.is_credit_card} onChange={e=>setEditForm({...editForm, is_credit_card: e.target.checked})} />
                                                <span className="text-sm">Tarjeta</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end">
                                            <button onClick={()=>setEditingId(null)} className="text-gray-500 text-sm px-3">Cancelar</button>
                                            <button onClick={()=>saveEdit(s.id)} className="bg-green-600 text-white px-3 py-1 rounded text-sm flex items-center gap-1"><IconSave /> Guardar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="font-bold">{s.name}</h3>
                                            <p className="text-xs text-gray-500">Vence d铆a {s.default_due_day} {s.is_credit_card ? '(Tarjeta)' : ''}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => { setEditingId(s.id); setEditForm({name:s.name, default_due_day:s.default_due_day, is_credit_card:s.is_credit_card}); }} className="text-gray-400 hover:text-blue-500 p-2"><IconEdit /></button>
                                            <button onClick={() => deleteService(s.id)} className="text-gray-400 hover:text-danger p-2"><IconTrash /></button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PaymentItem = ({ item, onUpdate, onDeletePayment }) => {
            const [inputValue, setInputValue] = useState('');

            useEffect(() => {
                const initialVal = item.is_paid ? item.amount_paid : item.amount_due;
                setInputValue(initialVal ? parseFloat(initialVal).toString() : '0');
            }, [item.amount_due, item.amount_paid, item.is_paid]);

            const handleBlur = async () => {
                const val = parseFloat(inputValue) || 0;
                if (!item.is_paid && val !== parseFloat(item.amount_due)) {
                    await onUpdate(item, { amount_due: val });
                }
            };

            const togglePaid = async () => {
                if (item.is_paid) {
                    await onDeletePayment(item.payment_id);
                } else {
                    const amountToPay = parseFloat(inputValue) || 0;
                    await onUpdate(item, { 
                        is_paid: true, 
                        amount_paid: amountToPay
                    });
                }
            };

            let borderColor = 'border-primary';
            let opacity = 'opacity-100';
            if (item.is_paid) borderColor = 'border-success', opacity = 'opacity-70';
            else if (item.skipped) borderColor = 'border-gray-300', opacity = 'opacity-50';
            else if (item.isOverdue) borderColor = 'border-danger';

            return (
                <div className={`card p-4 border-l-4 transition-all ${borderColor} ${opacity}`}>
                    <div className="flex justify-between mb-2">
                        <div className="flex-1">
                            <div className="flex items-center gap-2">
                                <h3 className={`font-bold text-gray-800 ${item.skipped ? 'line-through text-gray-400' : ''}`}>
                                    {item.name}
                                </h3>
                                {item.isOverdue && (
                                    <span className="bg-danger text-white text-[10px] font-bold px-1.5 py-0.5 rounded animate-pulse">
                                        VENCIDO
                                    </span>
                                )}
                            </div>
                            <p className="text-xs text-gray-500">Vence: D铆a {item.default_due_day}</p>
                            {item.carry_over_amount > 0 && (
                                <p className="text-xs text-orange-500 font-bold">Deuda arrastrada: {formatCurrency(item.carry_over_amount)}</p>
                            )}
                        </div>
                        <button onClick={() => onUpdate(item, { skipped: !item.skipped })} className="text-xs bg-gray-100 px-2 py-1 rounded h-fit hover:bg-gray-200">
                            {item.skipped ? 'Activar' : 'Saltar'}
                        </button>
                    </div>
                    
                    {!item.skipped && (
                        <div className="flex items-end gap-4 mt-1">
                            <div className="flex-1">
                                <div className={`flex items-center border-b ${item.isOverdue && !item.is_paid ? 'border-danger' : 'border-gray-200'} focus-within:border-primary transition-colors`}>
                                    <span className={`text-xl font-bold mr-1 ${item.isOverdue && !item.is_paid ? 'text-danger' : 'text-gray-600'}`}>$</span>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        className={`w-full text-xl font-bold outline-none bg-transparent py-1 ${item.isOverdue && !item.is_paid ? 'text-danger' : 'text-gray-800'}`}
                                        value={inputValue}
                                        onChange={(e) => setInputValue(e.target.value)}
                                        onBlur={handleBlur}
                                        onFocus={(e) => { 
                                            if (parseFloat(inputValue) === 0) setInputValue(''); 
                                        }}
                                        disabled={item.is_paid}
                                    />
                                </div>
                            </div>
                            <button onClick={togglePaid} className="transition-transform active:scale-90 shrink-0">
                                {item.is_paid ? <IconCheck /> : (
                                    <div className={item.isOverdue ? 'text-danger hover:text-red-700' : ''}>
                                        <IconCircle />
                                    </div>
                                )}
                            </button>
                        </div>
                    )}
                    
                    {item.is_paid && item.is_credit_card && (parseFloat(item.amount_due) - parseFloat(item.amount_paid)) > 0.01 && (
                         <p className="text-xs text-red-500 font-medium mt-2">
                             Restan {formatCurrency(parseFloat(item.amount_due) - parseFloat(item.amount_paid))} para el pr贸ximo mes.
                         </p>
                    )}
                </div>
            );
        };

        const DashboardView = ({ userId, supabaseInstance, services }) => {
            const [date, setDate] = useState(new Date());
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => { loadData() }, [date, services]); 

            const loadData = async () => {
                setLoading(true);
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();

                const viewMonth = date.getMonth() + 1;
                const viewYear = date.getFullYear();

                let prevMonth = viewMonth - 1;
                let prevYear = viewYear;
                if (prevMonth === 0) { prevMonth = 12; prevYear = viewYear - 1; }

                const { data: payments } = await supabaseInstance.from('payments').select('*').eq('month', viewMonth).eq('year', viewYear);
                const { data: prevPayments } = await supabaseInstance.from('payments').select('*').eq('month', prevMonth).eq('year', prevYear);

                if (services) {
                    const merged = services.map(svc => {
                        const pay = payments?.find(p => p.service_id === svc.id);
                        const prevPay = prevPayments?.find(p => p.service_id === svc.id);
                        
                        let carryOver = 0;
                        if (svc.is_credit_card && prevPay && prevPay.is_paid) {
                            carryOver = Math.max(0, (parseFloat(prevPay.amount_due) || 0) - (parseFloat(prevPay.amount_paid) || 0));
                        }

                        let amountDue = parseFloat(pay?.amount_due || 0);
                        if (!pay) {
                            amountDue = carryOver;
                        }

                        const isOverdue = !pay?.is_paid && !pay?.skipped && (
                            viewYear < currentYear || 
                            (viewYear === currentYear && viewMonth < currentMonth) ||
                            (viewYear === currentYear && viewMonth === currentMonth && currentDay > svc.default_due_day)
                        );

                        return {
                            ...svc,
                            payment_id: pay?.id,
                            amount_due: amountDue,
                            amount_paid: pay?.amount_paid || 0,
                            is_paid: pay?.is_paid || false,
                            skipped: pay?.skipped || false,
                            carry_over_amount: carryOver,
                            isOverdue: isOverdue
                        };
                    });
                    
                    const sorted = merged.sort((a, b) => {
                        if (a.is_paid !== b.is_paid) return a.is_paid ? 1 : -1;
                        return a.default_due_day - b.default_due_day;
                    });
                    setItems(sorted);
                }
                setLoading(false);
            };

            const updatePayment = async (item, updates) => {
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                const payload = {
                    service_id: item.id,
                    user_id: userId,
                    month,
                    year,
                    amount_due: updates.amount_due !== undefined ? updates.amount_due : item.amount_due,
                    amount_paid: updates.amount_paid !== undefined ? updates.amount_paid : item.amount_paid,
                    is_paid: updates.is_paid !== undefined ? updates.is_paid : item.is_paid,
                    skipped: updates.skipped !== undefined ? updates.skipped : item.skipped,
                };

                if (item.payment_id) {
                    await supabaseInstance.from('payments').update(payload).eq('id', item.payment_id);
                } else {
                    await supabaseInstance.from('payments').insert(payload);
                }
                loadData();
            };

            const deletePayment = async (id) => {
                await supabaseInstance.from('payments').delete().eq('id', id);
                loadData();
            };

            const totalPaid = items.filter(i => !i.skipped && i.is_paid).reduce((acc, c) => acc + parseFloat(c.amount_paid), 0);
            const remaining = items.filter(i => !i.skipped && !i.is_paid).reduce((acc, c) => acc + parseFloat(c.amount_due), 0);

            const changeMonth = (offset) => {
                const newDate = new Date(date);
                newDate.setMonth(newDate.getMonth() + offset);
                setDate(newDate);
            };

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-4xl mx-auto fade-in">
                    <div className="flex justify-between items-center mb-6 card p-3">
                        <button onClick={() => changeMonth(-1)} className="p-2 font-bold text-xl hover:bg-gray-100 rounded transition-colors">&lt;</button>
                        <h2 className="text-xl font-bold capitalize">{date.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 font-bold text-xl hover:bg-gray-100 rounded transition-colors">&gt;</button>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6 text-center">
                        <div className="bg-green-100 p-4 rounded-xl text-green-800 shadow-sm border border-green-200">
                            <div className="text-[10px] uppercase font-bold tracking-wider mb-1">Pagado</div>
                            <div className="font-bold text-xl">{formatCurrency(totalPaid)}</div>
                        </div>
                        <div className="bg-red-100 p-4 rounded-xl text-red-800 shadow-sm border border-red-200">
                            <div className="text-[10px] uppercase font-bold tracking-wider mb-1">Resta Pagar</div>
                            <div className="font-bold text-xl">{formatCurrency(remaining)}</div>
                        </div>
                    </div>

                    <div className="space-y-4">
                        {loading ? (
                            <div className="text-center p-8 text-gray-400">Cargando pagos...</div>
                        ) : (
                            items.map(item => (
                                <PaymentItem 
                                    key={item.id} 
                                    item={item} 
                                    onUpdate={updatePayment} 
                                    onDeletePayment={deletePayment}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const StatsView = ({ supabaseInstance, services }) => {
            const [annualData, setAnnualData] = useState([]);
            const [pieData, setPieData] = useState([]);
            const [allYearPayments, setAllYearPayments] = useState([]);
            const [selectedServiceId, setSelectedServiceId] = useState('');
            const [serviceAnnualData, setServiceAnnualData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const calc = async () => {
                    setLoading(true);
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = now.getMonth() + 1;

                    const { data: payments } = await supabaseInstance.from('payments')
                        .select('month, amount_paid, service_id')
                        .eq('year', year)
                        .eq('is_paid', true);
                    
                    setAllYearPayments(payments || []);

                    const chartData = Array.from({length: 12}, (_, i) => {
                        const m = i + 1;
                        const total = payments?.filter(p => p.month === m).reduce((acc, c) => acc + parseFloat(c.amount_paid), 0) || 0;
                        return { name: new Date(year, i, 1).toLocaleString('es-ES', {month:'short'}), total };
                    });
                    setAnnualData(chartData);

                    const { data: currentMonthPayments } = await supabaseInstance.from('payments').select('amount_paid, service_id').eq('year', year).eq('month', month).eq('is_paid', true);
                    
                    if (currentMonthPayments && services.length > 0) {
                        const distribution = currentMonthPayments.map(p => {
                            const svc = services.find(s => s.id === p.service_id);
                            return {
                                name: svc ? svc.name : 'Desconocido',
                                value: parseFloat(p.amount_paid)
                            };
                        }).filter(p => p.value > 0);
                        setPieData(distribution);
                        
                        // Seleccionar el primer servicio por defecto si no hay uno
                        if (!selectedServiceId && services.length > 0) {
                            setSelectedServiceId(services[0].id);
                        }
                    }
                    setLoading(false);
                };
                calc();
            }, [services]);

            // Efecto para calcular la evoluci贸n del servicio seleccionado
            useEffect(() => {
                if (!selectedServiceId || allYearPayments.length === 0) return;
                
                const currentYear = new Date().getFullYear();
                const chartData = Array.from({length: 12}, (_, i) => {
                    const m = i + 1;
                    const total = allYearPayments
                        .filter(p => p.month === m && String(p.service_id) === String(selectedServiceId))
                        .reduce((acc, c) => acc + parseFloat(c.amount_paid), 0) || 0;
                    return { name: new Date(currentYear, i, 1).toLocaleString('es-ES', {month:'short'}), total };
                });
                setServiceAnnualData(chartData);
            }, [selectedServiceId, allYearPayments]);

            if (loading) return <div className="text-center p-10 text-gray-500">Cargando estad铆sticas...</div>;

            return (
                <div className="p-4 pb-24 md:pt-10 max-w-4xl mx-auto space-y-8 fade-in">
                    <h2 className="text-xl font-bold">Resumen de Gastos</h2>

                    {/* Nueva secci贸n: Evoluci贸n por Servicio Individual */}
                    <div className="card p-6 border-l-4 border-success">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                            <h3 className="text-sm font-bold text-gray-400 uppercase">Evoluci贸n por Servicio</h3>
                            <select 
                                className="p-2 border rounded-lg bg-gray-50 text-sm outline-none focus:ring-2 focus:ring-primary"
                                value={selectedServiceId}
                                onChange={(e) => setSelectedServiceId(e.target.value)}
                            >
                                <option value="">Seleccionar servicio...</option>
                                {services.map(s => (
                                    <option key={s.id} value={s.id}>{s.name}</option>
                                ))}
                            </select>
                        </div>
                        {selectedServiceId ? (
                            <div className="h-[300px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={serviceAnnualData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                        <YAxis axisLine={false} tickLine={false} tickFormatter={(val) => `$${val/1000}k`} />
                                        <Tooltip formatter={(val) => [formatCurrency(val), 'Pagado']} />
                                        <Bar dataKey="total" fill="#10b981" radius={[6, 6, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        ) : (
                            <div className="h-[100px] flex items-center justify-center text-gray-400">
                                Selecciona un servicio para ver su evoluci贸n.
                            </div>
                        )}
                    </div>

                    <div className="card p-6">
                        <h3 className="text-sm font-bold text-gray-400 uppercase mb-6">Distribuci贸n Mes Actual</h3>
                        {pieData.length > 0 ? (
                            <div className="h-[300px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie
                                            data={pieData}
                                            cx="50%"
                                            cy="50%"
                                            innerRadius={60}
                                            outerRadius={80}
                                            paddingAngle={5}
                                            dataKey="value"
                                            label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
                                        >
                                            {pieData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                            ))}
                                        </Pie>
                                        <Tooltip formatter={(val) => formatCurrency(val)} />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                        ) : (
                            <div className="h-[100px] flex items-center justify-center text-gray-400">
                                No hay pagos registrados este mes para mostrar distribuci贸n.
                            </div>
                        )}
                    </div>

                    <div className="card p-6">
                        <h3 className="text-sm font-bold text-gray-400 uppercase mb-6">Gasto Total Mensual ({new Date().getFullYear()})</h3>
                        <div className="h-[300px]">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={annualData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                    <YAxis axisLine={false} tickLine={false} tickFormatter={(val) => `$${val/1000}k`} />
                                    <Tooltip formatter={(val) => [formatCurrency(val), 'Total']} />
                                    <Bar dataKey="total" fill="#3b82f6" radius={[6, 6, 0, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [supabaseInstance, setSupabaseInstance] = useState(null);
            const [session, setSession] = useState(null);
            const [view, setView] = useState('dashboard');
            const [services, setServices] = useState([]);

            const fetchServices = async (client, userId) => {
                if (!userId) return;
                const { data } = await client.from('services')
                    .select('*')
                    .eq('active', true)
                    .order('created_at');
                setServices(data || []);
            };

            useEffect(() => {
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                setSupabaseInstance(client);
                
                client.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) fetchServices(client, session.user.id);
                });

                const { data: { subscription } } = client.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) fetchServices(client, session.user.id);
                });
                return () => subscription.unsubscribe();
            }, []);

            if (!supabaseInstance) return <div className="p-10 text-center text-gray-500">Iniciando aplicaci贸n...</div>;
            if (!session) return <AuthView supabaseInstance={supabaseInstance} />;

            return (
                <div className="min-h-screen">
                    <main>
                        {view === 'dashboard' && (
                            <DashboardView 
                                userId={session.user.id} 
                                supabaseInstance={supabaseInstance} 
                                services={services}
                            />
                        )}
                        {view === 'services' && (
                            <ServicesView 
                                userId={session.user.id} 
                                supabaseInstance={supabaseInstance} 
                                services={services}
                                onRefresh={() => fetchServices(supabaseInstance, session.user.id)}
                            />
                        )}
                        {view === 'stats' && <StatsView supabaseInstance={supabaseInstance} services={services} />}
                    </main>

                    <nav className="fixed bottom-0 w-full bg-white border-t z-50">
                        <div className="flex justify-around items-center h-16 max-w-4xl mx-auto">
                            <button onClick={() => setView('dashboard')} className={`flex flex-col items-center p-2 transition-colors ${view==='dashboard'?'text-primary font-bold':'text-gray-400'}`}>
                                <IconDashboard /><span className="text-[10px]">Pagos</span>
                            </button>
                            <button onClick={() => setView('services')} className={`flex flex-col items-center p-2 transition-colors ${view==='services'?'text-primary font-bold':'text-gray-400'}`}>
                                <IconServices /><span className="text-[10px]">Servicios</span>
                            </button>
                            <button onClick={() => setView('stats')} className={`flex flex-col items-center p-2 transition-colors ${view==='stats'?'text-primary font-bold':'text-gray-400'}`}>
                                <IconStats /><span className="text-[10px]">Gr谩ficos</span>
                            </button>
                            <button onClick={() => supabaseInstance.auth.signOut()} className="flex flex-col items-center p-2 text-gray-400 hover:text-red-500 transition-colors">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                <span className="text-[10px]">Salir</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
